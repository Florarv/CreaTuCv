<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creador de CV para Primer Empleo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .ai-button {
            transition: all 0.3s ease;
        }
        .ai-button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(96, 165, 250, 0.5);
        }
        .template-preview {
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .template-preview.active {
            border-color: #3b82f6;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.4);
        }
        #resume-preview {
            transition: all 0.3s ease-in-out;
        }
        /* Estilos Template 1 (Moderno) */
        .template-modern .header { background-color: #1f2937; color: white; }
        .template-modern .section-title { border-bottom: 2px solid #3b82f6; color: #1f2937; }
        
        /* Estilos Template 2 (Clásico) */
        .template-classic .header { text-align: center; border-bottom: 2px solid #111827; }
        .template-classic .name { font-size: 2.5rem; font-weight: bold; }
        .template-classic .section-title { text-align: center; font-variant: small-caps; letter-spacing: 2px; background-color: #f3f4f6; margin-top: 1rem; }

        /* Estilos Template 3 (Creativo) - Color actualizado a Teal */
        .template-creative .header { background-color: #14b8a6; color: white; }
        .template-creative .name { font-size: 2.5rem; font-weight: 800; }
        .template-creative .title { font-size: 1.1rem; }
        .template-creative .section-title { color: #14b8a6; font-weight: bold; border-left: 4px solid #14b8a6; padding-left: 0.5rem; }
        .template-creative .contact-info div { display: flex; align-items: center; }
        .template-creative .contact-info svg { margin-right: 0.75rem; width: 16px; height: 16px; flex-shrink: 0; }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: none; /* Oculto por defecto */
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="flex flex-col lg:flex-row min-h-screen">
        <!-- Panel de Controles -->
        <aside class="w-full lg:w-1/2 xl:w-5/12 p-6 sm:p-8 bg-white overflow-y-auto">
            <div class="max-w-2xl mx-auto">
                <header class="mb-8">
                    <h1 class="text-3xl font-bold text-gray-900">Crea tu Primer CV</h1>
                    <p class="text-gray-600 mt-2">Diseñado para estudiantes y personas sin experiencia formal.</p>
                </header>

                <!-- Selección de Plantilla -->
                <div class="mb-8">
                    <h2 class="text-xl font-semibold mb-3">1. Elige una Plantilla</h2>
                    <div class="grid grid-cols-3 gap-4">
                        <div id="template-modern" class="template-preview active rounded-lg border-2 p-2 bg-gray-50" onclick="changeTemplate('template-modern')">
                            <img src="https://placehold.co/150x200/1f2937/FFFFFF?text=Moderno" class="rounded w-full h-auto" alt="Plantilla Moderna">
                            <p class="text-center text-sm mt-1">Moderno</p>
                        </div>
                        <div id="template-classic" class="template-preview rounded-lg border-2 p-2 bg-gray-50" onclick="changeTemplate('template-classic')">
                            <img src="https://placehold.co/150x200/f3f4f6/111827?text=Clásico" class="rounded w-full h-auto" alt="Plantilla Clásica">
                            <p class="text-center text-sm mt-1">Clásico</p>
                        </div>
                        <div id="template-creative" class="template-preview rounded-lg border-2 p-2 bg-gray-50" onclick="changeTemplate('template-creative')">
                            <img src="https://placehold.co/150x200/14b8a6/FFFFFF?text=Creativo" class="rounded w-full h-auto" alt="Plantilla Creativa">
                            <p class="text-center text-sm mt-1">Creativo</p>
                        </div>
                    </div>
                </div>

                <!-- Formulario -->
                <div id="resume-form">
                    <h2 class="text-xl font-semibold mb-4">2. Completa tu Información</h2>
                    
                    <!-- Datos Personales -->
                    <div class="bg-gray-50 p-4 rounded-lg mb-4">
                        <h3 class="font-semibold text-lg mb-2">Datos Personales</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" id="name" placeholder="Nombre Completo" class="p-2 border rounded w-full" oninput="updateField('name', this.value)">
                            <input type="text" id="title" placeholder="Tu Perfil o Carrera (Ej: Estudiante de Biología)" class="p-2 border rounded w-full" oninput="updateField('title', this.value)">
                            <input type="email" id="email" placeholder="Email" class="p-2 border rounded w-full" oninput="updateField('email', this.value)">
                            <input type="tel" id="phone" placeholder="Teléfono" class="p-2 border rounded w-full" oninput="updateField('phone', this.value)">
                            <input type="text" id="location" placeholder="Ubicación (Ej: Córdoba, Argentina)" class="p-2 border rounded w-full" oninput="updateField('location', this.value)">
                            <input type="text" id="linkedin" placeholder="URL de tu perfil de LinkedIn (Opcional)" class="p-2 border rounded w-full" oninput="updateField('linkedin', this.value)">
                        </div>
                        <div class="mt-4">
                            <label for="photo-upload" class="block text-sm font-medium text-gray-700 mb-1">Foto de Perfil (Opcional)</label>
                            <div class="mt-1 flex items-center gap-4">
                                <img id="photo-preview" src="https://placehold.co/80x80/e0e0e0/757575?text=Foto" class="h-20 w-20 rounded-full object-cover" alt="Vista previa de la foto">
                                <div class="flex flex-col">
                                    <input type="file" id="photo-upload" accept="image/*" class="hidden">
                                    <button type="button" onclick="document.getElementById('photo-upload').click()" class="bg-white py-2 px-3 border border-gray-300 rounded-md shadow-sm text-sm leading-4 font-medium text-gray-700 hover:bg-gray-50">
                                        Cambiar foto
                                    </button>
                                    <p class="text-xs text-gray-500 mt-2">Sugerencia: Usa una foto profesional con fondo neutro.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Perfil Profesional Guiado -->
                    <div class="bg-gray-50 p-4 rounded-lg mb-4">
                        <h3 class="font-semibold text-lg mb-2">Perfil Profesional (Guiado)</h3>
                        <p class="text-xs text-gray-500 mb-3">Responde estas preguntas y la IA creará un párrafo de perfil profesional por ti.</p>
                        <div class="space-y-3">
                            <input type="text" id="profile-q1" placeholder="¿Cuáles son tus mayores intereses o pasiones?" class="p-2 border rounded w-full">
                            <input type="text" id="profile-q2" placeholder="¿Qué te motiva o qué buscas en un rol?" class="p-2 border rounded w-full">
                            <input type="text" id="profile-q3" placeholder="Menciona 2-3 de tus habilidades principales." class="p-2 border rounded w-full">
                        </div>
                        <button onclick="enhanceWithAI('summary')" class="ai-button mt-3 flex items-center gap-2 bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-magic" viewBox="0 0 16 16"><path d="M9.5 2.672a.5.5 0 1 0 1 0V.843a.5.5 0 0 0-1 0v1.829Zm4.5.035A.5.5 0 0 0 13.293 2L12 3.293a.5.5 0 1 0 .707.707L14 2.707a.5.5 0 0 0 0-.707ZM7.293 4L8 3.293a.5.5 0 1 0-.707-.707L6.586 3.5a.5.5 0 0 0 0 .707l.707.707a.5.5 0 0 0 .707 0L8 4.707a.5.5 0 0 0 0-.707L7.293 4Zm-6.225.16a.5.5 0 0 0-.707 0L.293 4.232a.5.5 0 1 0 .707.707L1.068 5a.5.5 0 0 0 0-.707L.361 3.586a.5.5 0 0 0-.707.707l.072.072a.5.5 0 0 0 .707 0l.707-.707.707.707a.5.5 0 0 0 .707 0L3.293 4a.5.5 0 1 0-.707-.707L2 3.293a.5.5 0 0 0-.707.707l.072.072a.5.5 0 0 0 .707 0l.707-.707.707.707a.5.5 0 1 0 .707-.707L2.707 2l-.707.707a.5.5 0 0 0 0 .707l.707.707-.707.707a.5.5 0 0 0 0 .707l.707.707a.5.5 0 1 0 .707-.707L2.707 4l-.707.707a.5.5 0 0 0 0 .707l.707.707a.5.5 0 0 0 .707 0Z"/></svg>
                            Crear Perfil con IA
                            <div class="loader" id="loader-summary"></div>
                        </button>
                    </div>
                    
                    <!-- Proyectos y Actividades Guiado -->
                    <div class="bg-gray-50 p-4 rounded-lg mb-4">
                        <h3 class="font-semibold text-lg mb-2">Proyectos y Actividades (Guiado)</h3>
                        <p class="text-xs text-gray-500 mb-3">Responde sobre tus experiencias y la IA las redactará para tu CV.</p>
                        <div class="space-y-3">
                            <textarea id="activity-q1" placeholder="¿Participaste en algún equipo deportivo, club o grupo estudiantil? Describe tu rol." class="p-2 border rounded w-full h-16"></textarea>
                            <textarea id="activity-q2" placeholder="¿Hiciste algún voluntariado o ayudaste en alguna causa? ¿Qué hiciste?" class="p-2 border rounded w-full h-16"></textarea>
                            <textarea id="activity-q3" placeholder="¿Hay algún proyecto escolar o personal del que te sientas orgulloso? Descríbelo." class="p-2 border rounded w-full h-16"></textarea>
                        </div>
                        <button onclick="enhanceWithAI('activities')" class="ai-button mt-3 flex items-center gap-2 bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-magic" viewBox="0 0 16 16"><path d="M9.5 2.672a.5.5 0 1 0 1 0V.843a.5.5 0 0 0-1 0v1.829Zm4.5.035A.5.5 0 0 0 13.293 2L12 3.293a.5.5 0 1 0 .707.707L14 2.707a.5.5 0 0 0 0-.707ZM7.293 4L8 3.293a.5.5 0 1 0-.707-.707L6.586 3.5a.5.5 0 0 0 0 .707l.707.707a.5.5 0 0 0 .707 0L8 4.707a.5.5 0 0 0 0-.707L7.293 4Zm-6.225.16a.5.5 0 0 0-.707 0L.293 4.232a.5.5 0 1 0 .707.707L1.068 5a.5.5 0 0 0 0-.707L.361 3.586a.5.5 0 0 0-.707.707l.072.072a.5.5 0 0 0 .707 0l.707-.707.707.707a.5.5 0 0 0 .707 0L3.293 4a.5.5 0 1 0-.707-.707L2 3.293a.5.5 0 0 0-.707.707l.072.072a.5.5 0 0 0 .707 0l.707-.707.707.707a.5.5 0 1 0 .707-.707L2.707 2l-.707.707a.5.5 0 0 0 0 .707l.707.707-.707.707a.5.5 0 0 0 0 .707l.707.707a.5.5 0 1 0 .707-.707L2.707 4l-.707.707a.5.5 0 0 0 0 .707l.707.707a.5.5 0 0 0 .707 0Z"/></svg>
                            Crear Sección de Actividades
                            <div class="loader" id="loader-activities"></div>
                        </button>
                    </div>

                    <!-- Habilidades -->
                    <div class="bg-gray-50 p-4 rounded-lg mb-4">
                        <h3 class="font-semibold text-lg mb-2">Habilidades</h3>
                        <input type="text" id="skills" placeholder="Ej: Python, Liderazgo, Comunicación, Photoshop..." class="p-2 border rounded w-full" oninput="updateField('skills', this.value)">
                        <p class="text-xs text-gray-500 mt-1">Separa las habilidades con comas.</p>
                         <button onclick="generateSkillsFromActivities()" class="ai-button mt-2 flex items-center gap-2 bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600">
                             <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-lightbulb" viewBox="0 0 16 16"><path d="M2 6a6 6 0 1 1 10.174 4.31c-.203.196-.359.4-.453.619l-.762 1.769A.5.5 0 0 1 10.5 13a.5.5 0 0 1 0 1 .5.5 0 0 1 0 1l-.224.447a1 1 0 0 1-.894.553H6.618a1 1 0 0 1-.894-.553L5.5 15a.5.5 0 0 1 0-1 .5.5 0 0 1 0-1 .5.5 0 0 1-.46-.302l-.761-1.77a1.964 1.964 0 0 0-.453-.618A6 6 0 0 1 2 6zm6 8.5a.5.5 0 0 1 .5-.5h.5a.5.5 0 0 1 0 1l-.224.447a.5.5 0 0 1-.447.275H8.17a.5.5 0 0 1-.447-.275L7.5 15a.5.5 0 0 1 0-1h.5a.5.5 0 0 1 .5.5z"/></svg>
                            Generar Habilidades de Actividades
                             <div class="loader" id="loader-skills"></div>
                        </button>
                    </div>

                    <!-- Experiencia -->
                    <div class="bg-gray-50 p-4 rounded-lg mb-4">
                        <h3 class="font-semibold text-lg mb-2">Experiencia (Opcional)</h3>
                        <div id="experience-list"></div>
                        <button onclick="addExperience()" class="mt-2 bg-gray-200 text-gray-700 py-1 px-3 rounded hover:bg-gray-300">+ Añadir Experiencia</button>
                    </div>

                    <!-- Educación -->
                    <div class="bg-gray-50 p-4 rounded-lg mb-4">
                        <h3 class="font-semibold text-lg mb-2">Educación</h3>
                        <div id="education-list"></div>
                        <button onclick="addEducation()" class="mt-2 bg-gray-200 text-gray-700 py-1 px-3 rounded hover:bg-gray-300">+ Añadir Educación</button>
                    </div>

                    <!-- Espacio Publicitario -->
                    <div class="mt-6 p-4 border-2 border-dashed rounded-lg text-center text-gray-400">
                        <p class="text-sm font-medium">Espacio Publicitario</p>
                        <p class="text-xs">(Anuncio de 300x250)</p>
                    </div>
                </div>

                <!-- Botones de Acción -->
                <div class="mt-8 flex flex-col sm:flex-row gap-3">
                     <button onclick="checkSpelling()" class="w-full sm:w-1/2 bg-green-500 text-white py-3 px-4 rounded-lg font-semibold text-lg hover:bg-green-600 flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-spellcheck" viewBox="0 0 16 16"><path d="M7.243 9.776H3.834L3.622 10.5h-1.42L5.58 3.31h1.428l3.475 7.19h-1.457l-.248-.724H7.243zm-1.83-1.29H6.85L5.477 4.58h-.05l-1.42 3.906z"/><path d="M15.818 6.42a.5.5 0 0 0-.642-.06L14 6.847l-.94-1.88a.5.5 0 0 0-.894-.06L11 6.847l-.94-1.88a.5.5 0 0 0-.894-.06L8 6.847l-.94-1.88a.5.5 0 0 0-.894-.06L5.22 6.847l-.94-1.88a.5.5 0 1 0-.894.448l1.334 2.667.004.007a.5.5 0 0 0 .446.29h.004l.004-.002h6.5l.004.002h.004a.5.5 0 0 0 .446-.29l.004-.007 1.334-2.667a.5.5 0 0 0-.06-.642z"/></svg>
                        Revisar Ortografía
                    </button>
                     <button id="download-pdf" class="w-full sm:w-1/2 bg-blue-600 text-white py-3 px-4 rounded-lg font-semibold text-lg hover:bg-blue-700 flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-file-earmark-arrow-down" viewBox="0 0 16 16"><path d="M8.5 6.5a.5.5 0 0 0-1 0v3.793L6.354 9.146a.5.5 0 1 0-.708.708l2 2a.5.5 0 0 0 .708 0l2-2a.5.5 0 0 0-.708-.708L8.5 10.293V6.5z"/><path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 1.5L13 5H9.5V1.5z"/></svg>
                        Descargar CV en PDF
                    </button>
                </div>
            </div>
        </aside>

        <!-- Previsualización del CV -->
        <main class="w-full lg:w-1/2 xl:w-7/12 p-6 sm:p-8 bg-gray-200 flex flex-col items-center justify-center">
            <p class="text-center text-gray-600 mb-2 text-sm">💡 Consejo: Puedes hacer clic en el texto del CV para editarlo directamente.</p>
            <div id="pdf-content" class="w-full max-w-[210mm] aspect-[210/297] bg-white shadow-2xl">
                <div id="resume-preview" class="text-sm h-full w-full template-modern">
                    <!-- El contenido del CV se renderizará aquí -->
                </div>
            </div>
             <!-- Espacio Publicitario -->
            <div class="mt-4 p-4 w-full max-w-[728px] border-2 border-dashed rounded-lg text-center text-gray-400 bg-gray-100">
                <p class="text-sm font-medium">Espacio Publicitario</p>
                <p class="text-xs">(Anuncio de 728x90)</p>
            </div>
        </main>
    </div>
    
    <!-- Modal para mensajes -->
    <div id="message-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm text-center">
            <h3 id="modal-title" class="text-lg font-bold mb-2"></h3>
            <p id="modal-message" class="text-gray-700"></p>
            <button onclick="closeModal()" class="mt-4 bg-blue-500 text-white py-2 px-4 rounded-lg">Entendido</button>
        </div>
    </div>


    <script>
        // --- ESTADO DE LA APLICACIÓN ---
        const resumeData = {
            name: '', title: '', email: '', phone: '', location: '', linkedin: '',
            profilePicture: null,
            summary: '',
            experience: [],
            education: [],
            activitiesText: '',
            skills: [],
            template: 'template-modern'
        };

        // --- MANEJADORES DE EVENTOS DEL FORMULARIO ---
        function updateField(field, value) {
            if (field === 'skills') {
                 resumeData.skills = value.split(',').map(s => s.trim()).filter(Boolean);
            } else {
                resumeData[field] = value;
            }
            renderResume();
        }
        
        document.getElementById('photo-upload').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    resumeData.profilePicture = event.target.result;
                    document.getElementById('photo-preview').src = event.target.result;
                    renderResume();
                };
                reader.readAsDataURL(file);
            }
        });

        // --- FUNCIONES DE RENDERIZADO ---
        function renderResume() {
            const preview = document.getElementById('resume-preview');
            preview.className = `h-full w-full ${resumeData.template}`; 
            
            if (resumeData.template === 'template-classic') {
                preview.innerHTML = renderClassicTemplate();
            } else if (resumeData.template === 'template-creative') {
                preview.innerHTML = renderCreativeTemplate();
            } else {
                preview.innerHTML = renderModernTemplate();
            }
        }

        function renderModernTemplate() {
            return `
                <div class="p-8">
                    <header class="header p-6 rounded-t-lg flex justify-between items-center">
                        <div>
                            <h1 contenteditable="true" onblur="resumeData.name = this.innerText" class="name text-3xl font-bold">${resumeData.name || 'Tu Nombre'}</h1>
                            <p contenteditable="true" onblur="resumeData.title = this.innerText" class="title text-blue-300">${resumeData.title || 'Tu Perfil o Carrera'}</p>
                        </div>
                        ${resumeData.profilePicture ? `<img src="${resumeData.profilePicture}" class="h-24 w-24 rounded-full object-cover border-4 border-gray-700">` : ''}
                    </header>
                    <div class="p-6 grid grid-cols-3 gap-6">
                        <div class="col-span-2">
                            ${resumeData.summary ? `<div class="mb-4"><h2 class="section-title text-lg font-semibold pb-1 mb-2">Perfil</h2><p contenteditable="true" onblur="resumeData.summary = this.innerHTML">${resumeData.summary.replace(/\n/g, '<br>')}</p></div>` : ''}
                            ${resumeData.activitiesText ? `<div class="mb-4"><h2 class="section-title text-lg font-semibold pb-1 mb-2">Proyectos y Actividades</h2><div contenteditable="true" onblur="resumeData.activitiesText = this.innerHTML">${resumeData.activitiesText}</div></div>` : ''}
                            ${resumeData.experience.length > 0 ? `<div class="mb-4"><h2 class="section-title text-lg font-semibold pb-1 mb-2">Experiencia</h2>${renderExperienceSection()}</div>` : ''}
                            ${resumeData.education.length > 0 ? `<div class="mb-4"><h2 class="section-title text-lg font-semibold pb-1 mb-2">Educación</h2>${renderEducationSection()}</div>` : ''}
                        </div>
                        <div class="col-span-1">
                            <div class="mb-4">
                                <h2 class="section-title text-lg font-semibold pb-1 mb-2">Contacto</h2>
                                <p contenteditable="true" onblur="resumeData.email = this.innerText">${resumeData.email || ''}</p>
                                <p contenteditable="true" onblur="resumeData.phone = this.innerText">${resumeData.phone || ''}</p>
                                <p contenteditable="true" onblur="resumeData.location = this.innerText">${resumeData.location || ''}</p>
                                ${resumeData.linkedin ? `<p contenteditable="true" onblur="resumeData.linkedin = this.innerText" class="text-blue-500 break-all">${resumeData.linkedin}</p>` : ''}
                            </div>
                            ${resumeData.skills.length > 0 ? `<div><h2 class="section-title text-lg font-semibold pb-1 mb-2">Habilidades</h2><ul class="list-disc list-inside">${resumeData.skills.map(skill => `<li contenteditable="true" onblur="updateSkill(this, ${resumeData.skills.indexOf(skill)})">${skill}</li>`).join('')}</ul></div>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderClassicTemplate() {
            return `
                <div class="p-8">
                    <header class="header pb-4 text-center">
                         ${resumeData.profilePicture ? `<img src="${resumeData.profilePicture}" class="h-28 w-28 rounded-full object-cover mx-auto mb-4 border-4 border-gray-200">` : ''}
                        <h1 contenteditable="true" onblur="resumeData.name = this.innerText" class="name">${resumeData.name || 'Tu Nombre'}</h1>
                        <p contenteditable="true" onblur="resumeData.title = this.innerText" class="title text-lg">${resumeData.title || 'Tu Perfil o Carrera'}</p>
                        <div class="contact-info text-gray-600 flex justify-center flex-wrap gap-x-4 mt-2">
                            <span contenteditable="true" onblur="resumeData.email = this.innerText">${resumeData.email || 'email@ejemplo.com'}</span>
                            <span contenteditable="true" onblur="resumeData.phone = this.innerText">${resumeData.phone || '555-1234'}</span>
                            <span contenteditable="true" onblur="resumeData.location = this.innerText">${resumeData.location || 'Ciudad, País'}</span>
                            ${resumeData.linkedin ? `<span contenteditable="true" onblur="resumeData.linkedin = this.innerText">${resumeData.linkedin}</span>` : ''}
                        </div>
                    </header>
                    <div class="mt-4">
                        ${resumeData.summary ? `<div class="mb-4"><h2 class="section-title text-lg font-semibold py-1 mb-2">Perfil Profesional</h2><p contenteditable="true" onblur="resumeData.summary = this.innerHTML" class="text-center mt-2">${resumeData.summary.replace(/\n/g, '<br>')}</p></div>` : ''}
                        ${resumeData.activitiesText ? `<div class="mb-4"><h2 class="section-title text-lg font-semibold py-1 mb-2">Proyectos y Actividades</h2><div contenteditable="true" onblur="resumeData.activitiesText = this.innerHTML" class="text-justify mt-2">${resumeData.activitiesText}</div></div>` : ''}
                        ${resumeData.experience.length > 0 ? `<div class="mb-4"><h2 class="section-title text-lg font-semibold py-1 mb-2">Experiencia</h2>${renderExperienceSection()}</div>` : ''}
                        ${resumeData.education.length > 0 ? `<div class="mb-4"><h2 class="section-title text-lg font-semibold py-1 mb-2">Educación</h2>${renderEducationSection()}</div>` : ''}
                        ${resumeData.skills.length > 0 ? `<div class="mb-4"><h2 class="section-title text-lg font-semibold py-1 mb-2">Habilidades</h2><div class="flex flex-wrap justify-center gap-2 mt-2">${resumeData.skills.map(skill => `<span class="bg-gray-200 text-gray-800 px-3 py-1 rounded-full" contenteditable="true" onblur="updateSkill(this, ${resumeData.skills.indexOf(skill)})">${skill}</span>`).join('')}</div></div>` : ''}
                    </div>
                </div>
            `;
        }

        function renderCreativeTemplate() {
            return `
                <div class="grid grid-cols-3 h-full">
                    <div class="col-span-1 header flex flex-col rounded-l-lg">
                        <div class="p-8 text-center">
                            ${resumeData.profilePicture ? `<img src="${resumeData.profilePicture}" class="h-32 w-32 rounded-full object-cover mx-auto mt-4 mb-6 border-4 border-teal-400">` : ''}
                            <h1 contenteditable="true" onblur="resumeData.name = this.innerText" class="name break-words">${resumeData.name || 'Tu Nombre'}</h1>
                            <p contenteditable="true" onblur="resumeData.title = this.innerText" class="title mb-6">${resumeData.title || 'Tu Título'}</p>
                            <div class="contact-info space-y-3 text-left mt-4 break-words">
                                ${resumeData.email ? `<div><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M.05 3.555A2 2 0 0 1 2 2h12a2 2 0 0 1 1.95 1.555L8 8.414.05 3.555zM0 4.697v7.104l5.803-3.558L0 4.697zM6.761 8.83l-6.57 4.027A2 2 0 0 0 2 14h12a2 2 0 0 0 1.808-1.144l-6.57-4.027L8 9.586l-1.239-.757zm3.436-.586L16 11.801V4.697l-5.803 3.546z"/></svg><span contenteditable="true" onblur="resumeData.email = this.innerText">${resumeData.email}</span></div>` : ''}
                                ${resumeData.phone ? `<div><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.885.511a1.745 1.745 0 0 1 2.61.163L6.29 2.98c.329.423.445.974.28 1.465l-2.13 2.13a1.09 1.09 0 0 0-.102.278l.003.004c.043.11.11.213.208.334.098.12.215.248.357.41.14.16.282.31.45.49.168.18.328.34.48.48.15.15.29.29.42.42.12.12.22.21.31.29l.004.003c.046.03.09.06.13.08.047.024.096.045.146.062l.004.001c.063.017.126.03.189.038.063.008.127.012.19.012.064 0 .128-.004.19-.012.063-.008.126-.016.189-.038l.004-.002c.05-.017.099-.038.146-.062.04-.02.084-.04.13-.08l.003-.004c.1-.08.19-.17.29-.31.12-.14.25-.28.41-.45.17-.17.33-.33.49-.48.18-.17.34-.32.48-.45.14-.14.28-.28.42-.42.12-.12.21-.22.29-.31l.003-.004a.95.95 0 0 0 .08-.13c.024-.047.045-.096.062-.146l.001-.004c.017-.063.03-.126.038-.189.008-.063.012-.127.012-.19 0-.064-.004-.128-.012-.19-.008-.063-.016-.126-.038-.189l-.002-.004c-.017-.05-.038-.099-.062-.146a.95.95 0 0 0-.08-.13l-.004-.003c-.08-.1-.17-.19-.31-.29-.14-.12-.28-.25-.45-.41-.17-.14-.33-.28-.48-.42-.18-.14-.34-.28-.48-.42-.14-.14-.28-.28-.42-.42-.12-.12-.22-.21-.31-.29l-.004-.003a.95.95 0 0 0-.13-.08c-.047-.024-.096-.045-.146-.062l-.004-.001c-.063-.017-.126-.03-.189-.038-.063-.008-.127-.012-.19-.012a1.745 1.745 0 0 1-1.465-.28l-2.98-2.29a1.745 1.745 0 0 1-.163-2.61zM14.01 9.19c.18.18.29.39.34.62l-3.26 3.26c-.23.1-.44.18-.62.34-.18.18-.39.29-.62.34l-3.26 3.26c-.23.1-.44.18-.62.34-.18.18-.39.29-.62.34l-3.26 3.26c-.23.1-.44.18-.62.34a1.745 1.745 0 0 1-2.41-2.41c.1-.23.18-.44.34-.62l3.26-3.26c.1-.23.18-.44.34-.62.18-.18.29-.39.34-.62l3.26-3.26c.1-.23.18-.44.34-.62.18-.18.29-.39.34-.62l3.26-3.26c.23-.1.44-.18.62-.34a1.745 1.745 0 0 1 2.41 2.41z"/></svg><span contenteditable="true" onblur="resumeData.phone = this.innerText">${resumeData.phone}</span></div>` : ''}
                                ${resumeData.location ? `<div><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10zm0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/></svg><span contenteditable="true" onblur="resumeData.location = this.innerText">${resumeData.location}</span></div>` : ''}
                                ${resumeData.linkedin ? `<div><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M0 1.146C0 .513.526 0 1.175 0h13.65C15.474 0 16 .513 16 1.146v13.708c0 .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487 0 14.854V1.146zm4.943 12.248V6.169H2.542v7.225h2.401zm-1.2-8.212c.837 0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248-.822 0-1.359.54-1.359 1.248 0 .694.521 1.248 1.327 1.248h.016zm4.908 8.212V9.359c0-.955.017-2.176 1.355-2.176 1.338 0 1.561 1.002 1.561 2.106v4.213h2.401V9.25c0-2.22-1.184-3.252-2.764-3.252-1.274 0-1.845.7-2.165 1.193v.025h-.016a5.54 5.54 0 0 1 .016-.025V6.169h-2.4c.03.678 0 7.225 0 7.225h2.4z"/></svg><span contenteditable="true" onblur="resumeData.linkedin = this.innerText">${resumeData.linkedin}</span></div>` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="col-span-2 p-8">
                        ${resumeData.summary ? `<div class="mb-6"><h2 class="section-title text-xl mb-2">Perfil</h2><p contenteditable="true" onblur="resumeData.summary = this.innerHTML">${resumeData.summary.replace(/\n/g, '<br>')}</p></div>` : ''}
                        ${resumeData.activitiesText ? `<div class="mb-6"><h2 class="section-title text-xl mb-2">Proyectos y Actividades</h2><div contenteditable="true" onblur="resumeData.activitiesText = this.innerHTML">${resumeData.activitiesText}</div></div>` : ''}
                        ${resumeData.experience.length > 0 ? `<div class="mb-6"><h2 class="section-title text-xl mb-2">Experiencia</h2>${renderExperienceSection()}</div>` : ''}
                        ${resumeData.education.length > 0 ? `<div class="mb-6"><h2 class="section-title text-xl mb-2">Educación</h2>${renderEducationSection()}</div>` : ''}
                        ${resumeData.skills.length > 0 ? `<div><h2 class="section-title text-xl mb-2">Habilidades</h2><div class="flex flex-wrap gap-2">${resumeData.skills.map(skill => `<span class="bg-teal-100 text-teal-800 px-3 py-1 rounded-full text-sm" contenteditable="true" onblur="updateSkill(this, ${resumeData.skills.indexOf(skill)})">${skill}</span>`).join('')}</div></div>` : ''}
                    </div>
                </div>
            `;
        }
        
        function renderExperienceSection() {
            return resumeData.experience.map(exp => `
                <div class="mb-3">
                    <h3 class="font-bold" contenteditable="true" onblur="exp.jobTitle = this.innerText">${exp.jobTitle || 'Cargo'}</h3>
                    <p class="text-gray-600" contenteditable="true" onblur="exp.company = this.innerText; renderResume()">${exp.company || 'Empresa'} | ${exp.startDate || 'Fecha'} - ${exp.endDate || 'Fecha'}</p>
                    <p class="mt-1" contenteditable="true" onblur="exp.description = this.innerText">${exp.description || ''}</p>
                </div>
            `).join('');
        }

        function renderEducationSection() {
            return resumeData.education.map(edu => `
                <div class="mb-3">
                    <h3 class="font-bold" contenteditable="true" onblur="edu.degree = this.innerText">${edu.degree || 'Título'}</h3>
                    <p class="text-gray-600" contenteditable="true" onblur="edu.school = this.innerText">${edu.school || 'Institución'} | ${edu.year || 'Año'}</p>
                </div>
            `).join('');
        }


        // --- FUNCIONES DINÁMICAS (AÑADIR/QUITAR CAMPOS) ---
        function addExperience() {
            const id = `exp-${Date.now()}`;
            resumeData.experience.push({ id, jobTitle: '', company: '', startDate: '', endDate: '', description: '' });
            renderExperienceFields();
        }
        
        function addEducation() {
            const id = `edu-${Date.now()}`;
            resumeData.education.push({ id, degree: '', school: '', year: '' });
            renderEducationFields();
        }
        
        function removeExperience(id) {
            resumeData.experience = resumeData.experience.filter(exp => exp.id !== id);
            renderExperienceFields();
            renderResume();
        }
        
        function removeEducation(id) {
            resumeData.education = resumeData.education.filter(edu => edu.id !== id);
            renderEducationFields();
            renderResume();
        }

        function updateExperience(id, field, value) {
            const exp = resumeData.experience.find(e => e.id === id);
            if (exp) exp[field] = value;
            renderResume();
        }
        
        function updateEducation(id, field, value) {
            const edu = resumeData.education.find(e => e.id === id);
            if (edu) edu[field] = value;
            renderResume();
        }

        function updateSkill(element, index) {
            const newSkill = element.innerText;
            if (newSkill) {
                resumeData.skills[index] = newSkill;
            } else {
                resumeData.skills.splice(index, 1);
            }
            renderResume();
        }

        function renderExperienceFields() {
            const container = document.getElementById('experience-list');
            container.innerHTML = resumeData.experience.map(exp => `
                <div class="border p-3 rounded mt-2 bg-white">
                    <input type="text" value="${exp.jobTitle}" oninput="updateExperience('${exp.id}', 'jobTitle', this.value)" placeholder="Cargo" class="p-2 border rounded w-full mb-2">
                    <input type="text" value="${exp.company}" oninput="updateExperience('${exp.id}', 'company', this.value)" placeholder="Empresa" class="p-2 border rounded w-full mb-2">
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <input type="text" value="${exp.startDate}" oninput="updateExperience('${exp.id}', 'startDate', this.value)" placeholder="Fecha de Inicio" class="p-2 border rounded w-full">
                        <input type="text" value="${exp.endDate}" oninput="updateExperience('${exp.id}', 'endDate', this.value)" placeholder="Fecha de Fin" class="p-2 border rounded w-full">
                    </div>
                    <textarea oninput="updateExperience('${exp.id}', 'description', this.value)" placeholder="Descripción de tus tareas..." class="p-2 border rounded w-full h-20">${exp.description}</textarea>
                    <button onclick="removeExperience('${exp.id}')" class="text-red-500 hover:text-red-700 font-semibold mt-1">Quitar</button>
                </div>
            `).join('');
        }

        function renderEducationFields() {
            const container = document.getElementById('education-list');
            container.innerHTML = resumeData.education.map(edu => `
                <div class="border p-3 rounded mt-2 bg-white">
                    <input type="text" value="${edu.degree}" oninput="updateEducation('${edu.id}', 'degree', this.value)" placeholder="Título (Ej: Bachiller, Licenciatura en...)" class="p-2 border rounded w-full mb-2">
                    <input type="text" value="${edu.school}" oninput="updateEducation('${edu.id}', 'school', this.value)" placeholder="Institución Educativa" class="p-2 border rounded w-full mb-2">
                    <input type="text" value="${edu.year}" oninput="updateEducation('${edu.id}', 'year', this.value)" placeholder="Año de finalización" class="p-2 border rounded w-full mb-2">
                    <button onclick="removeEducation('${edu.id}')" class="text-red-500 hover:text-red-700 font-semibold mt-1">Quitar</button>
                </div>
            `).join('');
        }

        // --- FUNCIONALIDAD DE PLANTILLAS Y PDF ---
        function changeTemplate(templateName) {
            resumeData.template = templateName;
            document.querySelectorAll('.template-preview').forEach(el => el.classList.remove('active'));
            document.getElementById(templateName).classList.add('active');
            renderResume();
        }

        document.getElementById('download-pdf').addEventListener('click', () => {
            const content = document.getElementById('pdf-content');
            const preview = document.getElementById('resume-preview');
            const originalClasses = preview.className;
            
            preview.classList.add('shadow-none');

            html2canvas(content, {
                scale: 3, 
                useCORS: true,
                logging: false,
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });

                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save('cv_profesional.pdf');

                preview.className = originalClasses;
            });
        });

        // --- FUNCIONES DE IA ---
        async function callGeminiAPI(prompt, loaderId) {
            const loader = document.getElementById(loaderId);
            if(loader) loader.style.display = 'block';

            // LLAMADA A LA FUNCIÓN DE NETLIFY
            const apiUrl = `/.netlify/functions/call-gemini`;
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt }) // Enviar el prompt en el cuerpo
                });

                if (!response.ok) {
                    throw new Error(`Error en el servidor: ${response.statusText}`);
                }

                const result = await response.json();
                return result.text; // La función de Netlify devolverá un objeto { text: "..." }

            } catch (error) {
                console.error("Error al llamar a la función de Netlify:", error);
                showMessage("Error de IA", "Hubo un problema al contactar al asistente de IA. Por favor, inténtalo de nuevo más tarde.");
                return null;
            } finally {
                if(loader) loader.style.display = 'none';
            }
        }
        
        async function enhanceWithAI(section) {
            if (section === 'summary') {
                const q1 = document.getElementById('profile-q1').value;
                const q2 = document.getElementById('profile-q2').value;
                const q3 = document.getElementById('profile-q3').value;

                if (!q1 || !q2 || !q3) {
                    showMessage("Información Faltante", "Por favor, responde las tres preguntas para que la IA pueda generar tu perfil.");
                    return;
                }

                const prompt = `Actúa como un experto en redacción de currículums para alguien sin experiencia. Con base en la siguiente información, escribe un párrafo de perfil profesional conciso y atractivo (de 2 a 3 frases).
                - Intereses y pasiones: "${q1}"
                - Motivaciones y objetivos: "${q2}"
                - Habilidades principales: "${q3}"
                
                Responde únicamente con el párrafo final.`;
                
                const enhancedText = await callGeminiAPI(prompt, 'loader-summary');
                if (enhancedText) {
                    resumeData.summary = enhancedText.trim();
                    renderResume();
                    showMessage("Perfil Creado", "Tu perfil profesional ha sido generado por la IA y actualizado en el CV.");
                }
            } else if (section === 'activities') {
                const q1 = document.getElementById('activity-q1').value;
                const q2 = document.getElementById('activity-q2').value;
                const q3 = document.getElementById('activity-q3').value;

                if (!q1 && !q2 && !q3) {
                    showMessage("Información Faltante", "Responde al menos una pregunta para que la IA pueda generar esta sección.");
                    return;
                }

                const prompt = `Actúa como un experto en redacción de currículums. Basado en las siguientes experiencias de una persona joven, crea una sección de "Proyectos y Actividades" para un CV. Formatea cada experiencia como un punto de lista (usando <ul> y <li>) con un título claro y una breve descripción. Usa verbos de acción fuertes.
                - Experiencia en equipos/grupos: "${q1}"
                - Voluntariado/Colaboración: "${q2}"
                - Proyectos escolares/personales: "${q3}"
                
                Responde únicamente con el bloque de HTML (la lista <ul>), sin incluir \`\`\`html al principio o \`\`\` al final.`;

                const enhancedText = await callGeminiAPI(prompt, 'loader-activities');
                if (enhancedText) {
                    const cleanedText = enhancedText.trim().replace(/^```html\s*/, '').replace(/```$/, '').trim();
                    resumeData.activitiesText = cleanedText;
                    renderResume();
                    showMessage("Sección Creada", "Tu sección de actividades ha sido generada por la IA.");
                }
            }
        }

        async function generateSkillsFromActivities() {
            if (!resumeData.activitiesText) {
                showMessage("Información Faltante", "Primero genera la sección de 'Proyectos y Actividades' para que la IA pueda sugerirte habilidades.");
                return;
            }

            const prompt = `Basado en la siguiente lista HTML de actividades y proyectos de una persona, extrae de 5 a 7 habilidades profesionales clave (habilidades blandas o duras). Responde únicamente con una lista de habilidades separadas por comas, sin texto introductorio. Actividades: "${resumeData.activitiesText}"`;

            const skillsText = await callGeminiAPI(prompt, 'loader-skills');

            if (skillsText) {
                const skillsInput = document.getElementById('skills');
                const existingSkills = skillsInput.value ? skillsInput.value.split(',').map(s => s.trim()) : [];
                const newSkills = skillsText.split(',').map(s => s.trim().replace(/\.$/, ''));
                
                const combinedSkills = [...new Set([...existingSkills, ...newSkills])].filter(Boolean);
                
                skillsInput.value = combinedSkills.join(', ');
                updateField('skills', skillsInput.value);
                showMessage("Habilidades Generadas", "Se han añadido nuevas habilidades a tu lista basadas en tus actividades. ¡Revísalas!");
            }
        }

        async function checkSpelling() {
            showMessage("Revisando...", "La IA está revisando la ortografía de tu CV. Esto puede tardar un momento.");
            
            const fieldsToCheck = ['summary', 'activitiesText'];
            let updates = 0;

            for (const field of fieldsToCheck) {
                if (resumeData[field]) {
                    const prompt = `Corrige la ortografía y gramática del siguiente texto para un currículum profesional. Devuelve solo el texto corregido, sin añadir introducciones, comentarios ni cambiar el formato HTML si lo hubiera. Texto original: "${resumeData[field]}"`;
                    const correctedText = await callGeminiAPI(prompt, null);
                    if (correctedText && correctedText.trim() !== resumeData[field]) {
                        resumeData[field] = correctedText.trim();
                        updates++;
                    }
                }
            }
            
            renderResume();
            showMessage("Revisión Completada", `La IA ha finalizado. Se realizaron ${updates} correcciones en tu CV.`);
        }
        
        // --- MODAL ---
        function showMessage(title, message) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-message').innerText = message;
            document.getElementById('message-modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('message-modal').classList.add('hidden');
        }

        // --- INICIALIZACIÓN ---
        window.onload = () => {
            renderResume();
            addEducation();
        };

    </script>
</body>
</html>
